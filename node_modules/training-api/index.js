const express = require('express')
const request = require('request-promise')
const bodyParser = require('body-parser')
const cors = require('cors')

const app = express()
const port = 4000

app.use(bodyParser.urlencoded({
  extended: true
}))
app.use(bodyParser.json())
app.use(cors(
  {
    origin: 'http://localhost:3000',
    optionsSuccessStatus: 200
  }
))

app.post('/', async (req, res) => {
  res.set({'Access-Control-Allow-Origin': '*'})
  postNumber = req.body.postNumber
  const options = {
    url: 'https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + postNumber,
    method: 'GET'
  }

  // サーバー接続の例外処理
  let e
  let results
  try {
    const startTime = performance.now()
    const postInfo = JSON.parse(await request(options))
    const endTime = (performance.now())
    const performanceTime = (endTime - startTime)
    results = {"postInfo": postInfo, "performanceTime": `${Math.round(performanceTime)}` + 'ms'}
  } catch (error) {
    e = error
  }
  let responseData
  if (results) {
    responseData = {...results}
  } else {
    console.log("エラー発生")
    console.log("エラーメッセージ", e.message)
    console.log(e)
    // console.log("エラーコード", e.cause.code)
  }
  res.send(responseData)
})

app.listen(port,() => console.log(`Node.js is listening to PORT:${port}`))
